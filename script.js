// Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÉÅÏàò
let slideIndex = 1;
let touchStartX = 0;
let touchEndX = 0;
const modalElement = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxOYPrBfGxApYH-8ffsgxJwjHc380NAyJPmZcy52YoDW-2wnShRLuK0KIxLMJyIo1sKCQ/exec";

// Ï¥àÍ∏∞Ìôî Ìï®Ïàò - DOMContentLoadedÏóêÏÑú Î™®Îì† Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
document.addEventListener('DOMContentLoaded', function() {
    initializeGallery();
    initializeModal();
    initializeGuestbook();
    preloadImages();
});

// Í∞§Îü¨Î¶¨ Ï¥àÍ∏∞Ìôî - Ïπ¥Ïπ¥Ïò§ÌÜ° Ïù∏Ïï± Î∏åÎùºÏö∞Ï†Ä Ìò∏ÌôòÏÑ± Í∞úÏÑ†
function initializeGallery() {
    const galleryItems = document.querySelectorAll('.gallery-item');
    
    galleryItems.forEach((item, index) => {
        // Ïó¨Îü¨ Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖÏùÑ ÎèôÏãúÏóê Îì±Î°ùÌïòÏó¨ Ìò∏ÌôòÏÑ± Í∞úÏÑ†
        const events = ['click', 'touchend', 'touchstart'];
        
        events.forEach(eventType => {
            item.addEventListener(eventType, function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // touchstartÎäî Î™®Îã¨ÏùÑ Ïó¥ÏßÄ ÏïäÍ≥† Îã®ÏàúÌûà ÌôúÏÑ±ÌôîÎßå
                if (eventType === 'touchstart') {
                    item.style.borderColor = 'var(--main-color)';
                    return;
                }
                
                // clickÍ≥º touchendÏóêÏÑú Î™®Îã¨ Ïó¥Í∏∞
                if (eventType === 'click' || eventType === 'touchend') {
                    console.log('Gallery item clicked/touched:', index + 1);
                    openModal();
                    currentSlide(index + 1);
                }
            }, { passive: false });
        });
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï¢ÖÎ£å Ïãú Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
        item.addEventListener('touchcancel', function() {
            item.style.borderColor = 'transparent';
        });
        
        // ÎßàÏö∞Ïä§ Î¶¨Î∏å Ïãú Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî (Îç∞Ïä§ÌÅ¨ÌÜ±Ïö©)
        item.addEventListener('mouseleave', function() {
            item.style.borderColor = 'transparent';
        });
        
        // Ìè¨Ïª§Ïä§ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä (ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏßÄÏõê)
        item.setAttribute('tabindex', '0');
        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openModal();
                currentSlide(index + 1);
            }
        });
    });
    
    // Ïπ¥Ïπ¥Ïò§ÌÜ° Ïù∏Ïï± Î∏åÎùºÏö∞Ï†Ä Í∞êÏßÄ Î∞è ÎåÄÏ≤¥ Ïù¥Î≤§Ìä∏ Îì±Î°ù
    if (isKakaoInAppBrowser()) {
        console.log('Ïπ¥Ïπ¥Ïò§ÌÜ° Ïù∏Ïï± Î∏åÎùºÏö∞Ï†Ä Í∞êÏßÄÎê®');
        addKakaoCompatibilityFixes();
    }
}

// Ïπ¥Ïπ¥Ïò§ÌÜ° Ïù∏Ïï± Î∏åÎùºÏö∞Ï†Ä Í∞êÏßÄ Ìï®Ïàò
function isKakaoInAppBrowser() {
    const userAgent = navigator.userAgent.toLowerCase();
    return userAgent.includes('kakaotalk') || 
           userAgent.includes('kakao') ||
           (userAgent.includes('mobile') && window.DeviceMotionEvent === undefined);
}

// Ïπ¥Ïπ¥Ïò§ÌÜ° Ìò∏ÌôòÏÑ± ÏàòÏ†ï Ìï®Ïàò
function addKakaoCompatibilityFixes() {
    const galleryItems = document.querySelectorAll('.gallery-item');
    
    galleryItems.forEach((item, index) => {
        // ÎåÄÏ≤¥ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ï∂îÍ∞Ä
        item.addEventListener('mousedown', function(e) {
            setTimeout(() => {
                openModal();
                currentSlide(index + 1);
            }, 100);
        });
        
        // ÎçîÎ∏îÌÉ≠ Ïù¥Î≤§Ìä∏ ÏßÄÏõê
        let tapCount = 0;
        item.addEventListener('touchend', function(e) {
            tapCount++;
            if (tapCount === 1) {
                setTimeout(() => {
                    if (tapCount === 1) {
                        openModal();
                        currentSlide(index + 1);
                    }
                    tapCount = 0;
                }, 300);
            }
        });
    });
}

// Î™®Îã¨ Ï¥àÍ∏∞Ìôî
function initializeModal() {
    const modalContainer = document.querySelector('.modal-container');
    if (modalContainer) {
        modalContainer.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);
        
        modalContainer.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);
    }
    
    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    window.onclick = function(event) {
        if (event.target == modalElement) {
            closeModal();
        }
    }
    
    // ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
    document.onkeydown = function(e) {
        if (modalElement.style.display === "flex") {
            if (e.key === "ArrowLeft") {
                plusSlides(-1);
            } else if (e.key === "ArrowRight") {
                plusSlides(1);
            } else if (e.key === "Escape") {
                closeModal();
            }
        }
    }
}

// Î∞©Î™ÖÎ°ù Ï¥àÍ∏∞Ìôî
function initializeGuestbook() {
    const guestbookForm = document.getElementById('guestbookForm');
    if (guestbookForm) {
        guestbookForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('guestName').value;
            const message = document.getElementById('guestMessage').value;
            
            if (name && message) {
                saveGuestbookEntry(name, message);
                sendToSlack(name, message);
                guestbookForm.reset();
            }
        });
    }
}

// Ïù¥ÎØ∏ÏßÄ ÌîÑÎ¶¨Î°úÎìú
function preloadImages() {
    const galleryImages = document.querySelectorAll('.gallery-item img');
    galleryImages.forEach(img => {
        const preloadImg = new Image();
        preloadImg.src = img.src;
    });
}

// Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
function openModal() {
    modalElement.style.display = "flex";
    const scrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.top = `-${scrollY}px`;
    document.body.style.overflow = 'hidden';
    document.body.dataset.scrollY = scrollY;
}

function closeModal() {
    modalElement.style.display = "none";
    const scrollY = document.body.dataset.scrollY;
    document.body.style.position = '';
    document.body.style.width = '';
    document.body.style.top = '';
    document.body.style.overflow = '';
    window.scrollTo(0, parseInt(scrollY || '0'));
}

function plusSlides(n) {
    slideIndex += n;
    showSlides();
}

function currentSlide(n) {
    slideIndex = n;
    showSlides();
}

function showSlides() {
    const galleryImages = document.querySelectorAll('.gallery-item img');
    const totalImages = galleryImages.length;
    
    if (slideIndex > totalImages) {
        slideIndex = 1;
    }
    if (slideIndex < 1) {
        slideIndex = totalImages;
    }
    
    modalImage.src = '';
    const img = new Image();
    img.onload = function() {
        modalImage.src = this.src;
    };
    img.src = galleryImages[slideIndex-1].src;
}

function handleSwipe() {
    if (touchEndX < touchStartX - 50) {
        plusSlides(1);
    } else if (touchEndX > touchStartX + 50) {
        plusSlides(-1);
    }
}

// Î∞©Î™ÖÎ°ù Í¥ÄÎ†® Ìï®ÏàòÎì§
function saveGuestbookEntry(name, message) {
    const entries = JSON.parse(localStorage.getItem('weddingGuestbook') || '[]');
    const newEntry = {
        name: name,
        message: message,
        date: new Date().toISOString()
    };
    entries.push(newEntry);
    localStorage.setItem('weddingGuestbook', JSON.stringify(entries));
}

function sendToSlack(name, message) {
    const data = {
        name: name,
        message: message,
        date: formatDate(new Date())
    };
    
    const url = new URL(googleScriptUrl);
    url.searchParams.append('name', data.name);
    url.searchParams.append('message', data.message);
    url.searchParams.append('date', data.date);

    fetch(url.toString(), {
        method: 'GET',
        mode: 'no-cors',
    })
    .then(() => {
        console.log("Ïä¨Îûô ÏöîÏ≤≠ ÏôÑÎ£å");
        showNotification("Ï∂ïÌïò Î©îÏãúÏßÄÍ∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§! üíå");
    })
    .catch(error => {
        console.error("Ïä¨Îûô ÏöîÏ≤≠ Ïò§Î•ò:", error);
        showNotification("Ï∂ïÌïò Î©îÏãúÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§! üíå");
    });
}

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}.${month}.${day}`;
}

function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
    }).catch(() => {
        // Ìè¥Î∞±
        const dummy = document.createElement('input');
        document.body.appendChild(dummy);
        dummy.value = url;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        alert('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
    });
}

function showNotification(message) {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    
    Object.assign(notification.style, {
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: 'var(--main-color)',
        color: 'white',
        padding: '12px 20px',
        borderRadius: '30px',
        boxShadow: '0 2px 10px rgba(0,0,0,0.2)',
        zIndex: '1000',
        fontSize: '14px',
        fontWeight: '500',
        opacity: '0',
        transition: 'opacity 0.3s ease-in-out'
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}
